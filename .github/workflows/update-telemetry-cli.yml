# This workflow:
#   1. Checks the latest telemetry-cli version available in the GCS production bucket
#   2. Compares against the current blob version in config/blobs.yml
#   3. If a newer version exists, downloads the binary from GCS, updates the BOSH
#      blob, uploads to the blobstore, commits, and pushes
#   4. Notifies Google Chat on failure
#
# IMPORTANT: This repo (telemetry-release) is hosted on github.com (pivotal-cf org),
# NOT on github.gwd.broadcom.net. The GitHub Actions runners on github.com cannot
# reach the internal GHE instance. Therefore, we download CLI binaries from the GCS
# production bucket (which the CLI release workflow uploads to) instead of from GHE
# releases. The GCS bucket is accessible from the public internet with credentials.
#
# Triggers:
#   - Daily at 07:00 UTC (midnight PT)
#   - Manual via workflow_dispatch
#
# Required secrets:
#   - GCS_SERVICE_ACCOUNT_KEY: GCP service account JSON for blobstore access
#   - GCS_CLI_BUCKET: Name of the GCS bucket containing CLI production builds
#     (stored in Vault at: concourse/tanzu-portfolio-insights/tpi-telemetry-cli-repo
#      key: cli-production-builds-bucket)

name: Update Telemetry CLI Blob

on:
  schedule:
    - cron: '0 7 * * *'  # Daily at 07:00 UTC (midnight PT)
  workflow_dispatch:       # Manual trigger

jobs:
  update-cli:
    name: Update telemetry-cli blob
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install BOSH CLI
      run: |
        echo "Installing BOSH CLI..."
        BOSH_VERSION=$(curl -sL "https://api.github.com/repos/cloudfoundry/bosh-cli/releases/latest" \
          | grep '"tag_name"' | head -1 | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+')
        BOSH_VERSION_NUM="${BOSH_VERSION#v}"
        curl -sL "https://github.com/cloudfoundry/bosh-cli/releases/download/${BOSH_VERSION}/bosh-cli-${BOSH_VERSION_NUM}-linux-amd64" \
          -o /usr/local/bin/bosh
        chmod +x /usr/local/bin/bosh
        bosh --version

    - name: Authenticate to GCP
      run: |
        # Write the service account key to a temp file for gcloud auth.
        # This secret expires every ~3 months and must be rotated manually.
        echo '${{ secrets.GCS_SERVICE_ACCOUNT_KEY }}' > /tmp/gcs-key.json

        # --- Validate the key before attempting auth ---
        if ! python3 -c "import json, sys; json.load(open(sys.argv[1]))" /tmp/gcs-key.json 2>/dev/null; then
          echo ""
          echo "============================================================"
          echo "ERROR: GCS_SERVICE_ACCOUNT_KEY is missing or invalid."
          echo "============================================================"
          echo ""
          echo "The GCP service account key has likely EXPIRED (rotates every ~3 months)"
          echo "or was never set."
          echo ""
          echo "This repo is on github.com (pivotal-cf org), NOT on Broadcom GHE,"
          echo "so we CANNOT use actions-brcm/vault-action to pull secrets automatically."
          echo "The key must be updated manually."
          echo ""
          echo "To fix:"
          echo "  1. Read the key from Vault:"
          echo "       vault read concourse/tanzu-portfolio-insights/tpi-telemetry-cli-repo"
          echo "  2. Copy the GCP service account JSON value"
          echo "  3. Update the GitHub secret on github.com:"
          echo "       gh secret set GCS_SERVICE_ACCOUNT_KEY -R pivotal-cf/telemetry-release"
          echo "============================================================"
          exit 1
        fi

        gcloud auth activate-service-account --key-file=/tmp/gcs-key.json
        echo "GCS authentication configured."

    - name: Run update-telemetry-cli script
      id: update
      env:
        GCS_SERVICE_ACCOUNT_KEY: ${{ secrets.GCS_SERVICE_ACCOUNT_KEY }}
        GCS_CLI_BUCKET: ${{ secrets.GCS_CLI_BUCKET }}
        CLI_SOURCE: gcs
      run: |
        chmod +x scripts/update-telemetry-cli.sh
        OUTPUT=$(./scripts/update-telemetry-cli.sh 2>&1) || EXIT_CODE=$?
        echo "${OUTPUT}"

        # Detect if no update was needed
        if echo "${OUTPUT}" | grep -q "NO_UPDATE=true"; then
          echo "updated=false" >> $GITHUB_OUTPUT
          echo "No update needed."
        elif [[ "${EXIT_CODE:-0}" -ne 0 ]]; then
          echo "updated=false" >> $GITHUB_OUTPUT
          exit "${EXIT_CODE}"
        else
          echo "updated=true" >> $GITHUB_OUTPUT
          # Extract the new version from the output
          NEW_VERSION=$(echo "${OUTPUT}" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+ -> [0-9]+\.[0-9]+\.[0-9]+' | awk '{print $3}')
          echo "version=${NEW_VERSION}" >> $GITHUB_OUTPUT
        fi

    - name: Commit and push
      if: steps.update.outputs.updated == 'true'
      run: |
        VERSION="${{ steps.update.outputs.version }}"
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        git add -A
        if git diff --cached --quiet; then
          echo "No changes to commit (unexpected)."
        else
          git commit -m "chore: update telemetry-cli blob to ${VERSION}"
          git push
          echo "Committed and pushed telemetry-cli blob update to ${VERSION}."
        fi

    - name: Clean up credentials
      if: always()
      run: rm -f /tmp/gcs-key.json

    - name: Notify Google Chat on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const webhook = '${{ secrets.GOOGLE_CHAT_WEBHOOK }}';
          if (!webhook) {
            console.log('GOOGLE_CHAT_WEBHOOK not configured, skipping notification.');
            return;
          }
          const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
          const message = {
            text: [
              `‚ùå *telemetry-release*: update-telemetry-cli workflow failed.`,
              `If the failure is in "Authenticate to GCP", the GCS_SERVICE_ACCOUNT_KEY secret has likely expired (rotates every ~3 months). ` +
              `Read the new key from Vault (concourse/tanzu-portfolio-insights/tpi-telemetry-cli-repo) and update the secret on github.com. ` +
              `This can't be automated because this repo is on github.com, not Broadcom GHE.`,
              `<${runUrl}|View run>`,
            ].join('\n'),
          };
          await fetch(webhook, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(message)
          });
