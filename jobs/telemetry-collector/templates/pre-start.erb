#!/usr/bin/env bash
set -eu

<% if p('enabled') == false %>
  rm -f /etc/cron.d/telemetry-collector-cron
  echo "The telemetry-collector is not enabled.  Exiting"
  exit 0
<% end %>


# Ensure log directory has correct permissions
chown -R vcap:vcap /var/vcap/sys/log

# Run collect-send script (will always succeed unless collection fails)
/var/vcap/jobs/telemetry-collector/bin/telemetry-collect-send /var/vcap/jobs/telemetry-collector/config/pre-start-collect.yml || exit_code=$?

if [ "${exit_code:-0}" -ne 0 ]; then
  echo "ERROR: telemetry-collect-send failed with exit code $exit_code" >&2
  exit $exit_code
fi

cp /var/vcap/jobs/telemetry-collector/config/telemetry-collector-cron /etc/cron.d/telemetry-collector-cron
